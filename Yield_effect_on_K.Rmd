---
title: "Sensitivity_sobel"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sensitivity)
library(pse)
library(tidyverse)
library(gridExtra)
library(graphics)

```

# Assignment
Adjust your almond model to  output ONLY the mean almond yield anomoly IF the users sets parameter (e.g mean_only = TRUE))

Perform a sensitivity analysis of how mean anomaly varies ALL of the parameters used in the yield model  
Assume parameters are normally distribute with standard deviation of 20% mean value

Rank the parameters in term of their sensitivity

Graph uncertainty in mean yield anomaly across all parameter uncertainty (boxplot and cummulative distribution of the output).

Repeat using the LHS and Sobel methods

Repeat using twice as many parameter sets as you did in your first sensitivity analysis - and look at how this changes the sensitivity results

Submit R markdown and short write up describing what you learned from the sensitivity analysis


```{r setsen, echo=TRUE, eval=TRUE}
source("./R/almondanomaly5.r")

#-- showing the amended function
almondanomaly

#-- read in climate data
clim <- read.table("clim.txt")

#-- summarize
df <- clim %>% group_by(month, year) %>% summarise(meantmax = mean(tmax_c), meantmin = mean(tmin_c),precip=sum(precip))
head(df)

#-- run almond anomaly function
Tn <- df$meantmin[df$month==2]
P <- df$precip[df$month==1]
year <- array(1989:2010)

baseline <- almondanomaly(year = year, Tn=Tn, P=P, mean_only = F)
baseline

# yields <- (baseline$YieldAnomaly+0.9)*2000
yields <- baseline$YieldAnomaly

yields <- list(mean=60, sd=30)

sapply(yields, function(x){ carryingcapacity(yield = x, parms = parms)})

```

Perform a sensitivity analysis of how mean anomaly varies for ALL of the parameters used in the yield model

--> Assume parameters are normally distribute with standard deviation of 20% mean value

```{r LHS params}
#-- name coefficients
factors = c("Tmincoeff1", "Tmincoeff2",  "Precipcoeff1",  "Precipcoeff2",  "CoeffE")

#-- choose the quantile function to use
q <- "qnorm"
q <- rep("qnorm",5)

# qnorm -- normal distributions
q.arg = list(list(mean =-0.015,  sd=0.015*0.2), 
             list(mean= -0.0046, sd=0.0046*0.2), 
             list(mean= -0.07,   sd=0.07*0.2),
             list(mean=  0.0043, sd=0.0043*0.2),
             list(mean=  0.28,   sd=0.28*0.2))

# -- Latin Hyper Cube sampling for uncertainty and sensitivity analysis
# set how many parameter sets to run -- 220 is 10 times the length of input climate records (1989-2010)
# r(M+1) gives the recommended number of evaluations where r is the number of local derivatives, M is the number of factors. By this convention I set nsets to 4(5+1)=24
nsets=50
# -- set number of bootstrap replicates for calculating PRCC
nboot=1000
# -- run LHS
LHS_sens_alm = LHS(model = NULL,factors = factors, N =  nsets, q = q, q.arg = q.arg, nboot = nboot)

#-- save parameter values. 
# get.data returns a data frame of the input data. In this case, input data is the normally distributed parameters
LHS_sens_pars = get.data(LHS_sens_alm)
head(LHS_sens_pars)


```

```{r LHS plots}
#-- plot density of some parameter
ggplot(LHS_sens_pars, aes(Tmincoeff1))+geom_density()

#-- plot density of some parameters together
ggplot(LHS_sens_pars, aes(x=Tmincoeff1, y=Precipcoeff2))+geom_density_2d()
ggplot(LHS_sens_pars, aes(x=Precipcoeff1, y=CoeffE))+geom_density_2d()
ggplot(LHS_sens_pars, aes(x=Tmincoeff2, y=CoeffE))+geom_density_2d()
ggplot(LHS_sens_pars, aes(x=Tmincoeff1, y=Tmincoeff2))+geom_density_2d()


#-- check for autocorrelation(?) -- independence of input parameters
library(GGally)
ggpairs(LHS_sens_pars)


```

Run LHS

```{r LHS sensitivity}

#-- run the model
tmpLHS=sapply(nsets, function(x){
  mapply(FUN=almondanomaly, 
         a=LHS_sens_pars$Tmincoeff1, 
         b=LHS_sens_pars$Tmincoeff2, 
         c=LHS_sens_pars$Precipcoeff1, 
         d=LHS_sens_pars$Precipcoeff2, 
         e=LHS_sens_pars$CoeffE,
         MoreArgs=list(year=year, Tn=Tn, P=P, mean_only=T))
  })
tmpLHS=sapply(nsets, function(x){
  mapply(FUN=carryingcapacity, 
         yield=LHS_sens_pars$yields,
         MoreArgs=list(parms=parms))
  })
sens_res_LHS <- tmpLHS

#-- use tell to supply the LHS function with the model output 
sens_alm_LHS = tell(LHS_sens_alm, sens_res_LHS, res.names="K")
sens_alm_LHS

#-- plot partial correlation coefficients
plotprcc(sens_alm_LHS)

#-- partial rank correlation coefficients allow us to rank input factors (i.e., coefficients) according to their relative contribution to output variability
sens_alm_LHS$prcc

#-- explore effects of each parameter on model output in scatter plots
#-- i.e., are is there a linear relationship between any input parameter and the outcome?
plotscatter(sens_alm_LHS, col="darkgreen", cex=5,  ylab="Yield Anomaly (tons/acre)")

#-- mean yield anomaly across all parameter uncertainty
#-- first with a CDF plot
#-- show how results are distributed over different values with an empirical cumulative distribution plot
plotecdf(sens_alm_LHS, col="red", lwd=5, xlab="Yield Anomaly (tons/acre)", stack = T)



```

```{r SOBOL}
#-- now do sobel method

#-- generate two examples of random number from parmeter distributions
#-- first random number set
np=nsets
Tc1 = rnorm(mean =-0.015,  sd=0.015*0.2, n=np)
Tc2 = rnorm(mean= -0.0046, sd=0.0046*0.2, n=np)
Pc1 = rnorm(mean= -0.07,   sd=0.07*0.2, n=np)
Pc2 = rnorm(mean=  0.0043, sd=0.0043*0.2, n=np)
Cof5= rnorm(mean=  0.28,   sd=0.28*0.2, n=np)
X1 = cbind.data.frame(Tc1, Tc2, Pc1, Pc2, Cof5) #, tmin=tmin, precip=precip)

#-- second random number set
Tc1 = rnorm(mean =-0.015,  sd=0.015*0.2, n=np)
Tc2 = rnorm(mean= -0.0046, sd=0.0046*0.2, n=np)
Pc1 = rnorm(mean= -0.07,   sd=0.07*0.2, n=np)
Pc2 = rnorm(mean=  0.0043, sd=0.0043*0.2, n=np)
Cof5= rnorm(mean=  0.28,   sd=0.28*0.2, n=np)
X2 =  cbind.data.frame(Tc1, Tc2, Pc1, Pc2, Cof5)

#-- run sobel without model
sens_alm_sobel = sobol2002(model = NULL, X1, X2, nboot = nboot)
# sens_Catm_sobel = sobol2007(model = NULL, X1, X2, nboot = 100)      # doesn't seem to work for this data format?
# sens_Catm_sobel = sobol(model = NULL, X1, X2, nboot = 100)          # doesn't give Total sensitivity index


# run model for all parameter sets
res_sobol = mapply(FUN=almondanomaly, a=sens_alm_sobel$X$Tc1, b=sens_alm_sobel$X$Tc2, c=sens_alm_sobel$X$Pc1, d=sens_alm_sobel$X$Pc2, e=sens_alm_sobel$X$Cof5, MoreArgs=list(year=year, Tn=Tn, P=P, mean_only=T))

#-- use tell to supply the sobol function with the model output 
sens_alm_sobel = sensitivity::tell(sens_alm_sobel,res_sobol, res.names="ya")

print(sens_alm_sobel)

#-- first-order indices (main effect without co-variance)
sens_alm_sobel$S

#-- total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_alm_sobel$T
sum(sens_alm_sobel$T$original)

#-- The difference between the main effect and total effect can tell us something about how the parameter influences results so in the main effect we include interactions with other parameters
plot(sens_alm_sobel, ylim = c(-0.5, 3))

```



Graph uncertainty in mean yield anomaly across all parameter uncertainty (boxplot and cummulative distribution of the output).

```{r sobol plots}

#-- now using box plots
# make a data frame for plotting
head(sens_alm_sobel$X)
nrow(sens_alm_sobel$X)
length(sens_alm_sobel$y)
sobol.res.df = cbind.data.frame(sens_alm_sobel$X, YieldAnomaly=sens_alm_sobel$y)
head(sobol.res.df)

# look at response of yield anomaly to the two most important variables (here it's Pc2 and Pc 1)
sens_alm_sobel$T

sob1 <- ggplot(sobol.res.df, aes(x = Pc2, y = YieldAnomaly, col=Pc1))
sob1 + geom_point() + labs(y="Yield (as anomoly)") + ggtitle("Response of Yield Anomaly to Precip coefficient 2 using Sobol 2002")

sobol.yield <- data.frame(method=rep(paste("sobol 2002 (nsets=",nsets,")"), length(sens_alm_sobel$y)), YieldAnomaly=sens_alm_sobel$y)

ggplot(sobol.yield, aes(method, YieldAnomaly, col=method))+geom_boxplot()+labs(y="Yield (as anomoly)")

#-- plot ecdf of sobol2002
#-- create an ecdf from sobol SA results
sob.ecdf <- ecdf(sens_alm_sobel$y)
plot(sob.ecdf, col="red", lwd=2, xlab="Yield Anomaly (tons/acre)", do.points=TRUE)

#-- get percentiles for sobol model output
head(sob.ecdf(sens_alm_sobel$y))
summary.stepfun(sob.ecdf)


```

Compare sobol and LHS sensitivity

```{r compare sensitivity}
#-- create a boxplot comparing results of sobol and LHS
LHS.yield <- data.frame(method=rep(paste("LHS (nsets=",nsets,")"), length(sens_alm_LHS$res)), YieldAnomaly=sens_alm_LHS$res)

LHS.sobol.res <- rbind(sobol.yield, LHS.yield)

both <- LHS.sobol.res

ggplot(both, aes(method, YieldAnomaly, col=method))+geom_boxplot()+labs(y="Yield (as anomoly)")


```
The PRCC plot shows that the greatest contribution to output variability is Precipitation coefficient 2, followed by Precipitation coefficient 1. The model is least sensitive to the fifth coefficient, followed by the temperature coefficients 1 and 2, respectively.

Repeat using twice as many parameter sets as you did in your first sensitivity analysis - and look at how this changes the sensitivity results

```{r double run LHS}
#-- set how many parameter sets to run
nsets=nsets*2
#-- set number of bootstrap replicates for calculating PRCC
nboot=1000
#-- run LHS
x2.LHS_sens_alm = LHS(model = NULL,factors = factors, N =  nsets, q = q, q.arg = q.arg, nboot = nboot)

#-- save parameter values. get.data returns a data frame of the input data. In this case, input data is the normally distributed parameters
x2.LHS_sens_pars = get.data(x2.LHS_sens_alm)

#####


#-- run the model
tmpLHS=sapply(nsets, function(x){
  mapply(FUN=almondanomaly, 
         a=x2.LHS_sens_pars$Tmincoeff1, 
         b=x2.LHS_sens_pars$Tmincoeff2, 
         c=x2.LHS_sens_pars$Precipcoeff1, 
         d=x2.LHS_sens_pars$Precipcoeff2, 
         e=x2.LHS_sens_pars$CoeffE,
         MoreArgs=list(year=year, Tn=Tn, P=P, mean_only=T))
  })
x2.sens_res_LHS <- tmpLHS

#-- use tell to supply the LHS function with the model output 
x2.sens_alm_LHS = tell(x2.LHS_sens_alm, x2.sens_res_LHS, res.names="ya")
x2.sens_alm_LHS

#-- plot partial correlation coefficients
plotprcc(x2.sens_alm_LHS)
plotprcc(sens_alm_LHS)

#-- partial rank correlation coefficients allow us to rank input factors (i.e., coefficients) according to their relative contribution to output variability
x2.sens_alm_LHS$prcc

#-- explore effects of each parameter on model output in scatter plots
plotscatter(x2.sens_alm_LHS, col="darkgreen", cex=5, ylab="Yield Anomaly (tons/acre)")

#-- mean yield anomaly across all parameter uncertainty
#-- first with a CDF plot
#-- show how results are distributed over different values with an empirical cumulative distribution plot
plotecdf(x2.sens_alm_LHS, col="red", lwd=5, xlab="Yield Anomaly (tons/acre)", stack = T)

x2.LHS.yield <- data.frame(method=rep(paste("LHS (nsets=",nsets,")"), length(x2.sens_alm_LHS$res)), YieldAnomaly=x2.sens_alm_LHS$res)

both <- rbind(both, x2.LHS.yield)


```

```{r sobol double run}
#-- now do sobel method

#-- generate two examples of random number from parmeter distributions
#-- first random number set
np=nsets
Tc1 = rnorm(mean =-0.015,  sd=0.015*0.2, n=np)
Tc2 = rnorm(mean= -0.0046, sd=0.0046*0.2, n=np)
Pc1 = rnorm(mean= -0.07,   sd=0.07*0.2, n=np)
Pc2 = rnorm(mean=  0.0043, sd=0.0043*0.2, n=np)
Cof5= rnorm(mean=  0.28,   sd=0.28*0.2, n=np)
X1 = cbind.data.frame(Tc1, Tc2, Pc1, Pc2, Cof5) #, tmin=tmin, precip=precip)

#-- second random number set
Tc1 = rnorm(mean =-0.015,  sd=0.015*0.2, n=np)
Tc2 = rnorm(mean= -0.0046, sd=0.0046*0.2, n=np)
Pc1 = rnorm(mean= -0.07,   sd=0.07*0.2, n=np)
Pc2 = rnorm(mean=  0.0043, sd=0.0043*0.2, n=np)
Cof5= rnorm(mean=  0.28,   sd=0.28*0.2, n=np)
X2 =  cbind.data.frame(Tc1, Tc2, Pc1, Pc2, Cof5)

#-- run sobel without model
x2.sens_alm_sobel = sobol2002(model = NULL, X1, X2, nboot = nboot)
# sens_Catm_sobel = sobol2007(model = NULL, X1, X2, nboot = 100)      # doesn't seem to work for this data format?
# sens_Catm_sobel = sobol(model = NULL, X1, X2, nboot = 100)          # doesn't give Total sensitivity index


# run model for all parameter sets
x2.res_sobol = mapply(FUN=almondanomaly, a=x2.sens_alm_sobel$X$Tc1, b=x2.sens_alm_sobel$X$Tc2, c=x2.sens_alm_sobel$X$Pc1, d=x2.sens_alm_sobel$X$Pc2, e=x2.sens_alm_sobel$X$Cof5, MoreArgs=list(year=year, Tn=Tn, P=P, mean_only=T))

#-- use tell to supply the sobol function with the model output 
x2.sens_alm_sobel = sensitivity::tell(x2.sens_alm_sobel,x2.res_sobol, res.names="ya")

print(x2.sens_alm_sobel)

#-- first-order indices (main effect without co-variance)
x2.sens_alm_sobel$S

#-- total sensitivity index -note that this partitions the output variance - so values sum to 1
x2.sens_alm_sobel$T
sum(x2.sens_alm_sobel$T$original)

#-- The difference between the main effect and total effect can tell us something about how the parameter influences results so in the main effect we include interactions with other parameters
plot(x2.sens_alm_sobel, ylim = c(-0.5, 3))
plot(sens_alm_sobel, ylim = c(-0.5, 3))

```


```{r sobol plots -double sets}

#-- now using box plots
# make a data frame for plotting
head(x2.sens_alm_sobel$X)
nrow(x2.sens_alm_sobel$X)
length(x2.sens_alm_sobel$y)
x2.sobol.res.df = cbind.data.frame(x2.sens_alm_sobel$X, YieldAnomaly=x2.sens_alm_sobel$y)
head(x2.sobol.res.df)

# look at response of yield anomaly to the two most important variables (here it's Pc2 and Pc 1)
x2.sens_alm_sobel$T

sob1 <- ggplot(x2.sobol.res.df, aes(x = Pc2, y = YieldAnomaly, col=Pc1))
sob1 + geom_point() + labs(y="Yield (as anomoly)") + ggtitle("Response of Yield Anomaly to Precip coefficient 2 using Sobol 2002")

x2.sobol.yield <- data.frame(method=rep(paste("sobol 2002 (nsets=",nsets,")"), length(x2.sens_alm_sobel$y)), YieldAnomaly=x2.sens_alm_sobel$y)

ggplot(sobol.yield, aes(method, YieldAnomaly, col=method))+geom_boxplot()+labs(y="Yield (as anomoly)")

#-- plot ecdf of sobol2002
#-- create an ecdf from sobol SA results
x2.sob.ecdf <- ecdf(x2.sens_alm_sobel$y)
plot(x2.sob.ecdf, col="red", lwd=2, xlab="Yield Anomaly (tons/acre)", do.points=TRUE)

#-- get percentiles for sobol model output
head(x2.sob.ecdf(x2.sens_alm_sobel$y))
summary.stepfun(sob.ecdf)


```

```{r compare all}
head(x2.sobol.yield)
both <- rbind(both,x2.sobol.yield)
ggplot(both, aes(method, YieldAnomaly, col=method))+geom_boxplot()+labs(y="Yield (as anomoly)")

```

Now run the model - and give results to sensitivity analysis data structure generated by LHS 
* this allows us to take advantage of LHS functions for plotting and analysis

**tell**

provides the sensitivity structure created by LHS, results from model simulations

* can also provide names for results

We can then use two plotting commands

* **plotscatter**
  * given x-y plot of parameter and result
* **plotprcc**
  * Partial rank correlation coefficient 
* **plotecdf**
  * Cummulatative distribution of results - gives you range



## Sobel

Sobel sensitivity analysis is similar to LHS approach 
Breaks variance of output into 

* variance associated directly with parameter alone (fraction associated with each parameter, sum to 1)
* variance associated with parameter and interaction with other parameters (sum can be more than 1)


Similar workflow to LHS

* run sobel to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from sobel


#  Example - lets try it both ways

Atmospheric Conductance as a function of windspeed, vegetation height and parameters


