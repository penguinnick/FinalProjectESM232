---
title: "Gorchels_Triozzi_ESM232_final"
author: "Nick Triozzi"
date: "5/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load functions

```

## Agricultural component

Poisson distribtuion to simulate variance in yields, submodel creates scalable output


```{r crops }
#-- function for simulating crop yield data

#-- Store crop parms in list to use for later
crop.parms=list(c(...))


```

## Some graph of crop submodel results

```{r yielddist, echo=FALSE}

# density plot?

```


## Livestock component

We're only interested in herd growth during one time step, and input parameters, especially fertility and survivability might be modified depending on the goals of the farmer. Here, we've modified the function evolve_pop to accouunt for additional herd reductions from slaughter. Two offtake rates are considered: 50% and 75% use rates for exploiting natural deaths for caloric gain. These figures variably affect different age categories each with its own fertility rate. Offtake for slaughter may have down-the-line consequences for herd size. 

```{r livestock, echo=FALSE}

source("./R/evolve_pop_wofftake.R")

nyears=50
nyears=nyears
# assign values for fertility for each of the age classes 
# number of daughters expected at age x from females still alive at age x
goatfert =  c(0,0.150,0.410,0.550,0.705, 0.695, 0.725, 0.515,0.515)
fertility = goatfert

# survivability - based on mortality rates female sheep (Redding Table IV-7)
goatsurv <- c(0.55, 0.90, 0.90, 0.95, 0.95, 0.90, 0.75, 0.50, 0.00)
survivability <- goatsurv

# initial population parameters
# p0 = c(33, 21, 17, 15, 13, 12, 11, 7, 4)
# sheepini = p0
# initialpop = sheepini
p0 = c(48, 23, 19, 15, 13, 12, 9, 6, 3)
goatini=p0
initialpop = goatini

# offtake rate per 100 adult does at 50% use rate of animals to die
goatoff=list(goatoff50 = c(10.8, 1.1, 0.9, 0.3, 0.3, 0.6, 1.1, 1.5 , 1.5),  # at 50%
     goatoff75 = c(16.2, 1.7, 1.4, 0.5, 0.4, 0.9, 1.6, 2.2 , 2.2)) # at 75% use rate

offtake= lapply(goatoff, function(o){o/p0}) # create offtake rates as % of initial population

# return mean offtake for each strategy
lapply(offtake,function(o){tmp=evolve_pop_wofftake(fertility, survivability, initialpop = p0, nstep = nyears, offtake=o); return(list(mean=mean(tmp[]$offtot)))})

# return mean offtake for each strategy
lapply(offtake,function(o){tmp=evolve_pop_wofftake(fertility, survivability, initialpop = p0, nstep = nyears, offtake=o); return(list(sd=sd(tmp[]$offtot)))})

tmp <- lapply(offtake,function(o){tmp=evolve_pop_wofftake(fertility, survivability, initialpop = p0, nstep = nyears, offtake=o); return(tmp)})



```



```{r plot livestock, echo=FALSE}

#-- compare population trends for both strategies 
goat50=cbind.data.frame(year=seq(1:nyears), t(tmp$goatoff50$popbyage))
goat75=cbind.data.frame(year=seq(1:nyears), t(tmp$goatoff75$popbyage))
agecats <- c("year", "0-1", "1-2", "2-3", "3-4", "4-5", "5-6", "6-7", "7-8", "8-9")
colnames(goat50)<- agecats
colnames(goat75)<- agecats
goat50_agesl= goat50 %>% gather(key="agecat", value="pop",-year)
goat75_agesl= goat75 %>% gather(key="agecat", value="pop",-year)

# plots
ggplot(goat50_agesl, aes(year, pop, fill=agecat))+geom_col()+labs(y="Population", fill="Age Group")
ggplot(goat75_agesl, aes(year, pop, fill=agecat))+geom_col()+labs(y="Population", fill="Age Group")

#-- compare offtake trends for both strategies 
goat50off=cbind.data.frame(year=seq(2:nyears), t(tmp$goatoff50$offtakes))
goat75off=cbind.data.frame(year=seq(2:nyears), t(tmp$goatoff75$offtakes))
colnames(goat50off)<- agecats
colnames(goat75off)<- agecats
goat50_agesl_off= goat50off %>% gather(key="agecat", value="slaughtered",-year)
goat75_agesl_off= goat75off %>% gather(key="agecat", value="slaughtered",-year)

# plots
ggplot(goat50_agesl_off, aes(year, pop, fill=agecat))+geom_col()+labs(y="Animals available for slaughter", fill="Age Group")
ggplot(goat75_agesl_off, aes(year, pop, fill=agecat))+geom_col()+labs(y="Animals available for slaughter", fill="Age Group")


```

## The Farmer's Choice Model

explanation

Here we set parameters.

```{r set up for sdp, echo=FALSE}

parms= list(x_crit=0, # critical mass to survive
            x_max=160, # maximal mass
            x_rep=4, # critical mass for reproduction
            t_max=50, # number of time steps
            npatch=2,
            hsr=36) 

rates=list(wheatY=data.frame(year=seq(1:50), mean_yield=rpois(n=50, lambda = 30)),
           # wheat_yield(wheatY) # generates wheat yield
           barleyY=data.frame(year=seq(1:50), mean_yield=rpois(n=50, lambda = 45)),
           # barley_yield(barleyY) # generates barley yield
           npatch=4,
           good.b=c(0, 0, 1.20, 1.80), # birthrates in good  year; cattle goats (current fitness)
           good.d=c(0, 0, 0.95, 0.85), # death rates in bad year; cattle goats (curent fitness)
           bad.b=c(0, 0, 1, 1.10),
           bad.d=c(0, 0, 0.65, 0.75),
           # pop.r.g <- c(0, 0, 1.14, 1.53) # population growth good year (expected gains)
           # pop.r.b <- c(0.65, 0.825)
           goodyear=c(0.25, 0.25, 0.8, 0.8)) #,
           # repr=c(0,0,1,5)) #,
           # pgoodyr.stock <- c(0.8, 0.8) # cows goats
           # pbadyr.stock <- c(0.2, 0.2)
           # pgoodyr.crop <- c(0.25, 0.25) # barley wheat
           # pbadyr.crop <- c(0.75, 0.75)
           # hsr=36)

x_class=parms$x_crit:parms$x_max
nmass=length(x_class)
times=1:(parms$t_max-1)

```

## more parameters

setting up data structures


```{r set up for sdp, echo=FALSE}





# initialize 
f <- matrix(nrow=parms$t_max,ncol=nmass ,0) # optimal fitness
s <- matrix(nrow=parms$t_max,ncol=nmass ,0) # surplus
pr.A = 0.25
pr.B = 0.8
best.strategy= list(crops=matrix(nrow=parms$t_max-1,ncol=nmass-1 ,0) ,stock=matrix(nrow=parms$t_max-1,ncol=nmass-1 ,0))
# bestpatch <- matrix(nrow=t_max-1,ncol=nmass-1,0) # best patch
Vs <- vector(length=parms$npatch) # current fitness
Vc <- vector(length=parms$npatch) # current fitness

# bestpatch <- matrix(nrow=parms$t_max-1,ncol=nmass-1,0) # best patch
# V <- vector(length=parms$npatch) # current fitness
f[parms$t_max,] <- 36
s[parms$t_max,] <- 20

# fitness <- function(x,t)
# {
#   xx <- pmin(x ,parms$x_max)
#   xx <- pmax(xx,parms$x_crit)
#   # fitness <- f[t,xx-parms$x_crit+1]
#   f[t,xx-parms$x_crit+1]
# }


plot(pressure)
```

Big build up

```{r deficit function, echo=FALSE}


deficit.surplus <- function(hsr, gains, maxwealth, x, t){
  # gains<- cropgains
  # maxwealth=160
  # hsr=36
  xx <- pmin(gains, maxwealth)
  d <- ifelse(xx-hsr>0, 0, xx-hsr)
  # d.index <- which.max(d)
  deficit <- d
  s <- ifelse(d==0, xx-hsr, 0)
  # s.index <- which.max(s)
  surplus <- s
  return(list(deficit=deficit, surplus=surplus))
  # f[t-1,x+1] <- surplus+x+1
}


```


```{r run the func}

##-- sdpfunction.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.











