---
title: "Growing Degree Days"
author: "Nick Triozzi"
date: "5/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(zoo)
library(stringr)
library(dplyr)
library(ggplot2)
library(mapview)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r weather data}
#-- read in station weather data
# weather <- read.table("weather_1952_2020.txt", stringsAsFactors = FALSE, header=T, na.strings=c('99999','99999.9','999.9'), sep = ",")
w <- read.table("weather_1952_2020.txt", sep = ",", header = T)
colnames(w)
df <- w[,c(1,3,4,18:20)]
head(df)

#-- remove asterisk from temperatures and force numeric for precip
df$TMAXC <- as.numeric(str_replace(df$MAX, '\\*', ''))
df$TMINC <- as.numeric(str_replace(df$MIN, '\\*', ''))
df$precip <- as.numeric(gsub("[^0-9.-]", "", df$PRCP))

#-- replace NA (9999.9) values with NA
df$TMAXC[df$TMAXC==9999.9] <- NA
df$TMINC[df$TMINC==9999.9] <- NA
df$precip[df$precip==99.99] <- 0

#-- convert F to Celcius
df$TMAXC <- ((df$TMAX-32)*5)/9
df$TMINC <- ((df$TMIN-32)*5)/9
df$TEMP <- ((df$TEMP-32)*5)/9

#-- some observations were missed. For min temps, if mean temp (TEMP) is lower than TMAXC, replace TMINC with TEMP, and vice versa
df$TMINC[is.na(df$TMINC)==TRUE] <- df$TEMP[is.na(df$TMINC)==TRUE]
df$TMAXC[is.na(df$TMAXC)==TRUE] <- df$TEMP[is.na(df$TMAXC)==TRUE]
nrow(df[!complete.cases(df),])

#-- Reformat DATE and create Year Month Day columns from NewDate column
df$date <- as.Date(as.character(df$YEARMODA), format("%Y%m%d"))
df$year = as.numeric(format(df$date, format = "%Y"))
df$month = as.numeric(format(df$date, format = "%m"))
df$day = as.numeric(format(df$date, format = "%d"))
head(df)

#-- rename station ID col
colnames(df)[1] <- "STATION"

#-- drop cols
df <- df[,c(1,3, 10:13, 7:9)]
head(df)

#-- read in stations and join to weather
stations <- read.csv("stations.csv", header = T)

#-- keep only Croatian stations
stations <- stations[stations$COUNTRY=="HR",]

#-- reformat station ID to match column in daily weather data
stations$STATION_ID <- (stations$STATION_ID-99999)/100000
stations <- stations[,c(1,2,7:9)]     # drop extra cols
HRstations <- inner_join(stations, df, by=c("STATION_ID"="STATION"))

```

Calculate 20-year average growing degree days for each station

```{r compute growing degree days}
source("./R/computeGDD.r")

HRstations$GDD <- compute.GDD(HRstations, HRstations$TMINC, HRstations$TMAXC, 10, 25 )

#-- not all stations have a full year of observations
HRs <- HRstations %>% group_by(STATION_ID,STATION,year) %>% summarize( meanT=mean(TEMP), precip=sum(precip), AnnGDD=sum(GDD), RecordTotal = length(na.omit(TMAXC)))
head(HRs)

#-- keep only stations with more than 360 observations in a year
HRs <- HRs[HRs$RecordTotal>360,]

#-- check out precip
ggplot(HRs, aes(year, precip)) + geom_line()   # some years are missing observations

#-- keep years starting 2000 and later
HRs <- HRs[HRs$year>1999,]

#-- plot precip
ggplot(HRs, aes(x = year, y = precip)) +  geom_line(aes(color = STATION, linetype = STATION)) 

#-- drop Losinj Island
HRs <- HRs[HRs$STATION!="LOSINJ ISLAND",]
ggplot(HRs, aes(x = year, y = precip)) +  geom_line(aes(color = STATION, linetype = STATION)) 

HRs2 <- HRs %>% group_by(STATION_ID, STATION) %>% summarize(meanT=mean(meanT), avg.precip=mean(precip), avg.AnnGDD=mean(AnnGDD))
#-- rejoin to stations
HRs.df <- data.frame(HRs2)
HR.annual <- inner_join(stations, HRs.df)#, by=c("STATION_ID"="STATION"))

```


```{r create spatial points data frame}

##-- create spatial points data frame
coords<-data.frame(x = HR.annual$LONGITUDE, y = HR.annual$LATITUDE) # create data frame of coordinates

#-- set crs for long/lat - wgs84
crs<-"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"

#-- create spdf
HR.stations <- SpatialPointsDataFrame(coords=coords, data = HR.annual, proj4string = CRS(crs))

#-- plot
plot(HR.stations)

#-- use mapview for looking at weather station locations
m1 <- mapview(HR.stations, zcol="avg.AnnGDD", label=HR.stations$STATION, map.types= "Esri.WorldImagery")
m1

```

```{r interpolate}
#-- interpolate Accumulated Growing Degree Days
P <- HR.stations # set variable P to HR. Stations
class(P)

#-- to interpolate, will need coords in meters
crs <- "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
P <- spTransform(P, CRSobj = crs)

#-- Load Croatia boudary map
hr <- readOGR(dsn="./vectors", layer = "HRV_adm2")
W <- hr # set variable W to croatia boundary
W <- spTransform(W, CRSobj = crs)
class(W)
mapview(W, zcol = "NAME_1", burst = TRUE, legend=F) + m1

#-- Replace point boundary extent with that of Croatia
P@bbox <- W@bbox

#-- Create an empty grid where n is the total number of cells ()
grd              <- as.data.frame(spsample(P, "regular", n=ncell(3000), cellsize=500))
names(grd)       <- c("X", "Y")
coordinates(grd) <- c("X", "Y")
gridded(grd)     <- TRUE  # Create SpatialPixel object
fullgrid(grd)    <- TRUE  # Create SpatialGrid object

#-- Add P's projection information to the empty grid
proj4string(grd) <- proj4string(P)

#-- Interpolate the grid cells using a power value of 2 (idp=2.0)
P.idw <- gstat::idw(avg.AnnGDD ~ 1, P, newdata=grd, idp=2.0)

#-- Convert to raster object then clip to HR boundary
r       <- raster(P.idw)
r.m     <- mask(r, W)
plot(r.m) # plot
mapview(r.m)


```


```{r plots of precip}
# 
# #-- are there any years missing data? 
# ggplot(df, aes(year)) + geom_histogram()
# 
# #-- summarize monthly data by station
# df2 <-  df %>% group_by(STATION, month, year) %>% summarize(meantmax = mean(TMAXC), meantmin = mean(TMINC), meanT=mean(TEMP), precip=sum(precip))
# 
# #-- read in stations and join to weather
# stations <- read.csv("stations.csv", header = T)
# 
# #-- keep only Croatian stations
# stations <- stations[stations$COUNTRY=="HR",]
# 
# #-- reformat station ID to match column in daily weather data
# stations$STATION_ID <- (stations$STATION_ID-99999)/100000
# stations <- stations[,c(1,2,7:9)]     # drop extra cols
# df3 <- inner_join(stations, df2, by=c("STATION_ID"="STATION"))
# 
# #-- Create seasonal summaries
# df3$Season[df3$month==3|df3$month==4|df3$month==5] <- "spring"
# df3$Season[df3$month==6|df3$month==7|df3$month==8] <- "summer"
# df3$Season[df3$month==9|df3$month==10|df3$month==11] <- "fall"
# df3$Season[df3$month==12|df3$month==1|df3$month==2] <- "winter"
# 
# ggplot(df3, aes(Season, precip)) + geom_boxplot()
# ggplot(df3, aes(Season, meanT)) + geom_boxplot()

```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
